# Donor Project - Project-Specific Standards

**Location**: `C:\projects\donor\.copilot-instructions-project-specific.md`  
**Project**: Donor Management System  
**Last Updated**: December 19, 2025

---

## üìã Referencing Global Standards

**Global standards apply to ALL work on this project:**
- Location: `C:\projects\.copilot-instructions.md`
- Contains: 16 Essential Quality Checks, debugging checklists, pre-deployment checklist
- **Always reference this file in every session**

**Error handling is shared across all projects:**
- Location: `C:\projects\STANDARDS\ERROR_HANDLING_SYSTEM\`
- Files in project: `C:\projects\donor\server\src\lib\`
- Reference in code: `const { ErrorCodes } = require('../lib/errorCodes');`

---

## üõ† Technology Stack

### Frontend
- **Framework**: React 18.3.1
- **Build Tool**: Vite
- **Development**: `npm run dev` ‚Üí http://localhost:5173
- **Production Build**: `npm run build` ‚Üí dist/
- **Key Dependencies**: React Router, Axios

### Backend
- **Runtime**: Node.js
- **Framework**: Express
- **Development**: `npm run dev` (from server/ folder) ‚Üí http://localhost:3001
- **Port**: 3001 (local), application port (VPS)
- **Key Dependencies**: express, pg (PostgreSQL), jsonwebtoken

### Database
- **Type**: PostgreSQL
- **Local**: `localhost:5432`
- **Database Name**: `donors_db`
- **Key Tables**: `users`, `students`, `applications`, `field_reviews`

### Web Server & Deployment
- **Local**: Direct Node.js (no web server)
- **VPS**: Nginx (reverse proxy)
- **Process Manager**: PM2
- **Domain**: https://aircrew.nl
- **Deployment**: Git pull ‚Üí npm install ‚Üí npm run build ‚Üí pm2 restart

---

## üì± Key Features & Their Locations

### 1. Photo Upload System
**What it does**: Students upload profile photos, caseworkers view them

**Files**:
- Frontend: `src/components/PhotoUploader.jsx`
- Backend routes: `server/routes/photoRoutes.js`
- Upload handler: `server/src/lib/photoHandler.js`
- Error codes: `server/src/lib/errorCodes.js` (PHOTO_UPLOAD_FAILED, etc.)

**Verification checklist**:
```
1. File uploaded to: /home/sohail/projects/donors/server/uploads/photos/
2. Nginx configured: /etc/nginx/sites-enabled/aircrew.nl has /uploads/ location
3. Test URL: curl -I https://aircrew.nl/uploads/photos/[filename].jpg
4. Result: HTTP/2 200 (not 404)
5. Persists after: pm2 restart all
```

### 2. Video Upload & Validation
**What it does**: Students submit videos (30-120 seconds), caseworkers review

**Duration requirements**:
- Minimum: 30 seconds
- Maximum: 120 seconds
- Error if < 30 seconds: "Video too short"
- Error if > 120 seconds: "Video too long"

**Files**:
- Frontend: `src/components/VideoUploader.jsx`
- Duration check: `src/lib/videoValidator.js`
- Backend validation: `server/routes/videoRoutes.js`

**Verification**:
```
1. Upload 20-second video ‚Üí rejected
2. Upload 30-second video ‚Üí accepted
3. Upload 120-second video ‚Üí accepted
4. Upload 121-second video ‚Üí rejected
5. Video persists in: /home/sohail/projects/donors/server/uploads/videos/
```

### 3. Case Worker Dashboard
**What it does**: Case workers see only their assigned students

**Files**:
- Frontend: `src/pages/CaseWorkerDashboard.jsx`
- API endpoint: `GET /api/case-worker/students`
- Database query: `server/src/lib/studentQueries.js`

**Role mapping** (IMPORTANT):
- Legacy role: `SUB_ADMIN`
- Current role: `CASE_WORKER`
- Both refer to the same user type
- When checking roles: look for `role === 'CASE_WORKER' OR role === 'SUB_ADMIN'`

**Verification**:
```
1. Login as CASE_WORKER
2. Should see only students assigned to this case worker
3. Should NOT see other case workers' students
4. Admin should see all students
5. Student should see only their own record
```

### 4. Application Review System
**What it does**: Case workers mark applications as "Approved", "Rejected", or "Pending Review"

**Files**:
- Frontend: `src/components/ApplicationReview.jsx`
- API endpoint: `POST /api/applications/:id/review`
- Status values: "PENDING_REVIEW", "APPROVED", "REJECTED"

**Database**:
- Table: `applications`
- Relevant fields: `id`, `student_id`, `status`, `reviewer_id`, `review_date`, `notes`

### 5. University Management
**What it does**: Students select university and program during application

**Files**:
- University data: `server/data/universities.json` or database
- API endpoint: `GET /api/universities`
- Frontend: `src/components/UniversitySelector.jsx`

---

## üîê Authentication & Authorization

### User Roles
1. **ADMIN** - Full system access
2. **CASE_WORKER** (or legacy SUB_ADMIN) - Can view/approve assigned students
3. **STUDENT** - Can only view own application
4. **DONOR** - Can view donor information (read-only)

### Role Checks
**Location**: `server/middleware/authMiddleware.js`

**Common patterns**:
```javascript
// Check if user is case worker
if (req.user.role !== 'CASE_WORKER' && req.user.role !== 'SUB_ADMIN') {
  throw new UnauthorizedError('Case worker access required');
}

// Check if user can access this student's data
if (req.user.role === 'STUDENT' && req.user.id !== studentId) {
  throw new ForbiddenError('Cannot access another student\'s data');
}
```

### Authentication Flow
```
1. User submits credentials ‚Üí POST /api/auth/login
2. Backend verifies ‚Üí JWT token created
3. Token sent to frontend ‚Üí stored in localStorage or cookie
4. Subsequent requests ‚Üí include token in Authorization header
5. Backend verifies token ‚Üí if valid, allow request; if expired, return 401
6. Frontend handles 401 ‚Üí redirect to login
```

---

## üóÑ Database Schema Essentials

### Primary Tables

#### `users` table
- `id` (PRIMARY KEY)
- `email` (UNIQUE)
- `password` (hashed)
- `role` ('ADMIN', 'CASE_WORKER', 'STUDENT', 'DONOR')
- `created_at`, `updated_at`

#### `students` table
- `id` (PRIMARY KEY)
- `user_id` (FOREIGN KEY ‚Üí users.id)
- `first_name`, `last_name`
- `cnic` (national ID)
- `phone`, `email`
- `photo_url` (path to uploaded photo)
- `assigned_case_worker_id` (FOREIGN KEY ‚Üí users.id)
- `created_at`, `updated_at`

#### `applications` table
- `id` (PRIMARY KEY)
- `student_id` (FOREIGN KEY ‚Üí students.id)
- `university_id` (FOREIGN KEY ‚Üí universities.id)
- `status` ('PENDING_REVIEW', 'APPROVED', 'REJECTED')
- `video_url` (path to uploaded video)
- `submitted_at`
- `reviewer_id` (FOREIGN KEY ‚Üí users.id)
- `review_notes`

#### `field_reviews` table
- `id` (PRIMARY KEY)
- `application_id` (FOREIGN KEY ‚Üí applications.id)
- `reviewer_id` (FOREIGN KEY ‚Üí users.id)
- `comments`, `rating`
- `reviewed_at`

---

## üîó Important URLs

### Local Development
- Frontend: http://localhost:5173
- Backend API: http://localhost:3001
- Database: localhost:5432

### Production
- Frontend: https://aircrew.nl
- Backend API: https://aircrew.nl/api
- Domain: aircrew.nl

---

## üìù Error Codes Specific to Donor Project

**Location**: `C:\projects\donor\server\src\lib\errorCodes.js`

**Common error codes used**:
- `STUDENT_NOT_FOUND` - Student record doesn't exist
- `PHOTO_UPLOAD_FAILED` - Photo upload error (size, format, etc.)
- `VIDEO_TOO_SHORT` - Video less than 30 seconds
- `VIDEO_TOO_LONG` - Video more than 120 seconds
- `UNIVERSITY_NOT_FOUND` - Selected university doesn't exist
- `APPLICATION_NOT_FOUND` - Application record missing
- `UNAUTHORIZED_CASE_WORKER` - Case worker doesn't have permission
- `INVALID_APPLICATION_STATUS` - Status value not recognized

**Always use**: `throw new EnhancedError('message', statusCode, ErrorCodes.YOUR_CODE, data);`

---

## üöÄ Common Tasks

### To Start Local Development
```bash
# Terminal 1: Backend
cd C:\projects\donor\server
npm install
npm run dev

# Terminal 2: Frontend
cd C:\projects\donor
npm install
npm run dev
```

### To Deploy to VPS
```bash
# On your machine
git add .
git commit -m "Feature description"
git push origin main

# On VPS
cd /path/to/donors
git pull origin main
npm install
npm run build
pm2 restart all

# Verify
curl -I https://aircrew.nl
pm2 status
```

### To Check Database
```bash
psql -U postgres -d donors_db -c "SELECT * FROM students LIMIT 5;"
psql -U postgres -d donors_db -c "SELECT * FROM applications WHERE status = 'PENDING_REVIEW';"
```

### To View Logs
```bash
# VPS
ssh user@host
pm2 logs
tail -f /var/log/nginx/aircrew.nl.error.log
```

---

## ‚ö†Ô∏è Common Issues & Fixes

### Issue: Photo shows "broken image" icon
**Debug steps**:
1. Check file exists: `ls -lh /home/sohail/projects/donors/server/uploads/photos/`
2. Check URL accessible: `curl -I https://aircrew.nl/uploads/photos/filename.jpg`
3. Check Nginx config: `sudo nginx -t` (should show "OK")
4. Check permissions: `ls -l /etc/nginx/sites-enabled/aircrew.nl`
5. If permissions wrong: `sudo chown -R nginx:nginx /path/to/uploads`

### Issue: Video validation not working
**Debug steps**:
1. Check validator exists: `cat server/src/lib/videoValidator.js`
2. Check route imports it: `grep -n "videoValidator" server/routes/videoRoutes.js`
3. Test with curl: `curl -X POST -F "video=@test.mp4" http://localhost:3001/api/video/upload`
4. Check backend console for logs

### Issue: Case worker sees all students instead of only assigned
**Debug steps**:
1. Check query filters by `assigned_case_worker_id`: `grep -A 5 "SELECT.*students" server/src/lib/studentQueries.js`
2. Check middleware adds user ID: `grep -n "req.user.id" server/middleware/authMiddleware.js`
3. Verify database has `assigned_case_worker_id` values: `SELECT id, first_name, assigned_case_worker_id FROM students;`

---

## üìã Pre-Deployment Verification for Donor Project

**Always do these before deploying:**

- [ ] Photo upload test: Can upload and access photo via HTTPS
- [ ] Video validation: 30-second video accepted, 20-second rejected
- [ ] Case worker dashboard: Only shows assigned students
- [ ] Application review: Status changes persist in database
- [ ] Role checks: Can't access other users' data
- [ ] Error messages: User-friendly (not stack traces)
- [ ] Database queries: All SELECT queries return expected results
- [ ] PM2 status: `pm2 status` shows all processes online
- [ ] Nginx: `sudo nginx -t` shows OK
- [ ] Git: `git status` shows clean working tree
- [ ] No console.log or debug code left in source
- [ ] Commit message describes change clearly

---

## üîó Quick Reference

| What | Where |
|------|-------|
| Global Standards | `C:\projects\.copilot-instructions.md` |
| Error Handling System | `C:\projects\STANDARDS\ERROR_HANDLING_SYSTEM\` |
| Project Error Codes | `C:\projects\donor\server\src\lib\errorCodes.js` |
| Setup Guide | `C:\projects\GLOBAL_STANDARDS_SETUP.md` |
| Frontend | `C:\projects\donor\src\` |
| Backend | `C:\projects\donor\server\` |
| Database | `donors_db` on localhost:5432 |
| Production | https://aircrew.nl |

---

**Remember**: Always reference the global standards before asking for help. Include error messages, commands, and what you already checked.
