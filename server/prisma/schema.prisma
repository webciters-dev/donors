generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                    String            @id @default(cuid())
  name                  String
  email                 String            @unique
  gender                String
  university            String
  field                 String
  program               String
  gpa                   Float
  gradYear              Int
  city                  String?
  country               String
  province              String?
  sponsored             Boolean           @default(false)
  studentPhase          StudentPhase?     @default(APPLICATION)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  cnic                  String?
  dateOfBirth           DateTime?
  guardianName          String?
  guardianCnic          String?
  phone                 String?
  address               String?
  currentInstitution    String?
  currentCity           String?
  currentCompletionYear Int?
  personalIntroduction  String?
  academicAchievements  String?
  careerGoals           String?
  communityInvolvement  String?
  currentAcademicYear   String?
  familySize            Int?
  monthlyFamilyIncome   String?
  parentsOccupation     String?
  specificField         String?
  messages              Message[]
  applications          Application[]
  conversations         Conversation[]
  disbursements         Disbursement[]
  documents             Document[]
  fieldReviews          FieldReview[]
  sponsorships          Sponsorship[]
  progressUpdates       StudentProgress[]
  progressReports       ProgressReport[]
  User                  User?

  @@map("students")
}

model Application {
  id                 String            @id @default(cuid())
  studentId          String
  term               String
  amount             Int               // Required: Education cost in specified currency
  currency           Currency          // Required: Currency of the education cost
  status             ApplicationStatus @default(PENDING)
  submittedAt        DateTime          @default(now())
  notes              String?
  fxRate             Float?
  amountOriginal     Int?
  currencyOriginal   Currency?
  amountBaseUSD      Int?
  baseCurrency       Currency?         @default(USD)
  fxRateToUSD        Float?
  fxAsOf             DateTime?
  tuitionFee         Int?
  hostelFee          Int?
  otherExpenses      Int?
  familyIncome       Int?
  familyContribution Int?
  purpose            String?
  approvalReason     String?
  livingExpenses     Int?
  scholarshipAmount  Int?
  totalExpense       Int?
  universityFee      Int?
  messages           Message[]
  student            Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  conversations      Conversation[]
  documents          Document[]
  fieldReviews       FieldReview[]

  @@map("applications")
}

model Message {
  id            String       @id @default(cuid())
  text          String
  fromRole      String
  createdAt     DateTime     @default(now())
  studentId     String
  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id])
  student       Student      @relation(fields: [studentId], references: [id])
}

model Conversation {
  id             String                @id @default(cuid())
  type           ConversationType
  participantIds String[]
  studentId      String?
  applicationId  String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  lastMessageAt  DateTime              @default(now())
  messages       ConversationMessage[]
  application    Application?          @relation(fields: [applicationId], references: [id])
  student        Student?              @relation(fields: [studentId], references: [id])

  @@map("conversations")
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  senderRole     UserRole
  text           String
  createdAt      DateTime     @default(now())
  readBy         String[]
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@map("conversation_messages")
}

model Donor {
  id                 String        @id @default(cuid())
  name               String
  email              String        @unique
  organization       String?
  totalFunded        Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  country            String?
  address            String?
  currencyPreference Currency?
  taxId              String?
  phone              String?
  sponsorships       Sponsorship[]
  User               User?

  @@map("donors")
}

model Sponsorship {
  id                    String    @id @default(cuid())
  donorId               String
  studentId             String
  amount                Int
  date                  DateTime  @default(now())
  status                String    @default("active")
  paymentFrequency      String?
  stripePaymentIntentId String?
  stripeSubscriptionId  String?
  amountOriginal        Int?
  currencyOriginal      Currency?
  amountBaseUSD         Int?
  baseCurrency          Currency? @default(USD)
  fxRateToUSD           Float?
  fxAsOf                DateTime?
  donor                 Donor     @relation(fields: [donorId], references: [id], onDelete: Cascade)
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("sponsorships")
}

model Disbursement {
  id               String             @id @default(cuid())
  studentId        String
  amount           Int
  date             DateTime           @default(now())
  status           DisbursementStatus @default(INITIATED)
  notes            String?
  amountOriginal   Int?
  currencyOriginal Currency?
  amountBaseUSD    Int?
  baseCurrency     Currency?          @default(USD)
  fxRateToUSD      Float?
  fxAsOf           DateTime?
  student          Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("disbursements")
}

model Document {
  id            String       @id @default(cuid())
  studentId     String
  applicationId String?
  type          DocumentType
  url           String
  originalName  String?
  mimeType      String?
  size          Int?
  uploadedAt    DateTime     @default(now())
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  student       Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([applicationId])
  @@map("documents")
}

model User {
  id             String                @id @default(cuid())
  name           String?
  email          String                @unique
  passwordHash   String
  role           UserRole
  studentId      String?               @unique
  donorId        String?               @unique
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  sentMessages   ConversationMessage[]
  fieldReviews   FieldReview[]         @relation("OfficerReviews")
  passwordResets PasswordReset[]
  donor          Donor?                @relation(fields: [donorId], references: [id])
  student        Student?              @relation(fields: [studentId], references: [id])

  @@map("users")
}

model FxRate {
  id     String   @id @default(cuid())
  base   Currency
  quote  Currency
  rate   Float
  asOf   DateTime @default(now())
  source String?

  @@unique([base, quote, asOf])
  @@map("fx_rates")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_resets")
}

model FieldReview {
  id                           String      @id @default(cuid())
  applicationId                String
  studentId                    String
  officerUserId                String
  status                       String      @default("PENDING")
  notes                        String?
  recommendation               String?
  homeVisitDate                DateTime?
  homeVisitNotes               String?
  familyInterviewNotes         String?
  financialVerificationNotes   String?
  characterAssessment          String?
  deservingnessFactor          Int?
  documentsVerified            Boolean     @default(false)
  identityVerified             Boolean     @default(false)
  familyIncomeVerified         Boolean     @default(false)
  educationVerified            Boolean     @default(false)
  recommendationReason         String?
  additionalDocumentsRequested String[]
  riskFactors                  String[]
  verificationScore            Int?
  fielderRecommendation        String?
  adminNotesRequired           String?
  createdAt                    DateTime    @default(now())
  updatedAt                    DateTime    @updatedAt
  application                  Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  officer                      User        @relation("OfficerReviews", fields: [officerUserId], references: [id], onDelete: Cascade)
  student                      Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([studentId])
  @@index([officerUserId])
  @@map("field_reviews")
}

model StudentProgress {
  id               String   @id @default(cuid())
  studentId        String
  term             String
  gpa              Float
  coursesCompleted Int?
  creditsEarned    Int?
  achievements     String?
  challenges       String?
  goals            String?
  notes            String?
  updateType       String   @default("academic")
  documents        Json?
  submittedAt      DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([submittedAt])
  @@map("student_progress")
}

enum ApplicationStatus {
  PENDING
  PROCESSING
  APPROVED
  REJECTED
  DRAFT
}

enum StudentPhase {
  APPLICATION  // Student is in application/review phase
  ACTIVE      // Student is approved and actively studying (with/without sponsor)
  GRADUATED   // Student has completed their program
}

enum DisbursementStatus {
  INITIATED
  COMPLETED
  FAILED
}

enum UserRole {
  STUDENT
  DONOR
  ADMIN
  SUB_ADMIN
}

enum DocumentType {
  CNIC
  GUARDIAN_CNIC
  PHOTO
  SSC_RESULT
  HSSC_RESULT
  UNIVERSITY_CARD
  FEE_INVOICE
  INCOME_CERTIFICATE
  UTILITY_BILL
  TRANSCRIPT
  DEGREE_CERTIFICATE
  ENROLLMENT_CERTIFICATE
  OTHER
}

enum Currency {
  USD
  PKR
  EUR
  GBP
  CAD
  AUD
}

enum ConversationType {
  DONOR_STUDENT
  DONOR_ADMIN
  STUDENT_ADMIN
}

enum ProgressReportStatus {
  SUBMITTED
  REVIEWED
  APPROVED
  NEEDS_REVISION
}

model ProgressReport {
  id          String                      @id @default(cuid())
  studentId   String
  title       String
  content     String
  status      ProgressReportStatus        @default(SUBMITTED)
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?
  
  student     Student                     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  attachments ProgressReportAttachment[]
  
  @@map("progress_reports")
}

model ProgressReportAttachment {
  id               String         @id @default(cuid())
  progressReportId String
  filename         String
  filepath         String
  mimetype         String
  size             Int
  createdAt        DateTime       @default(now())
  
  progressReport   ProgressReport @relation(fields: [progressReportId], references: [id], onDelete: Cascade)
  
  @@map("progress_report_attachments")
}
