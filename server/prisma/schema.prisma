generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                    String         @id @default(cuid())
  name                  String
  email                 String         @unique
  gender                String
  university            String
  field                 String
  program               String
  gpa                   Float
  gradYear              Int
  city                  String?
  country               String
  province              String?
  needUSD               Int
  sponsored             Boolean        @default(false)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  cnic                  String?
  dateOfBirth           DateTime?
  guardianName          String?
  guardianCnic          String?
  phone                 String?
  address               String?
  currentInstitution    String?
  currentCity           String?
  currentCompletionYear Int?
  // NEW OPTIONAL FIELDS - Won't break existing functionality
  personalIntroduction  String?        // Student's personal introduction about themselves and family
  detailedLocation      String?        // Specific village/area within city for more detailed location
  currentEducationDetails String?      // Details about current education program/courses
  academicResults       String?        // Current academic performance/grades description
  messages              Message[]
  applications          Application[]
  disbursements         Disbursement[]
  documents             Document[]
  fieldReviews          FieldReview[]
  sponsorships          Sponsorship[]
  conversations         Conversation[]
  User                  User?

  @@map("students")
}

model Application {
  id                 String            @id @default(cuid())
  studentId          String
  term               String
  needUSD            Int
  status             ApplicationStatus @default(PENDING)
  submittedAt        DateTime          @default(now())
  notes              String?
  fxRate             Float?
  currency           Currency?
  needPKR            Int?
  amountOriginal     Int?
  currencyOriginal   Currency?
  amountBaseUSD      Int?
  baseCurrency       Currency?         @default(USD)
  fxRateToUSD        Float?
  fxAsOf             DateTime?
  tuitionFee         Int?
  hostelFee          Int?
  otherExpenses      Int?
  familyIncome       Int?
  familyContribution Int?
  purpose            String?
  // NEW OPTIONAL FIELD - Sub admin's reasoning for approval/rejection
  approvalReason     String?           // Sub admin's detailed reasoning for recommendation
  messages           Message[]
  student            Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  documents          Document[]
  fieldReviews       FieldReview[]
  conversations      Conversation[]

  @@map("applications")
}

model Message {
  id            String       @id @default(cuid())
  text          String
  fromRole      String
  createdAt     DateTime     @default(now())
  studentId     String
  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id])
  student       Student      @relation(fields: [studentId], references: [id])
}

// NEW MESSAGING SYSTEM - Extended communication for donors
model Conversation {
  id              String             @id @default(cuid())
  type            ConversationType   // DONOR_STUDENT, DONOR_ADMIN, etc.
  participantIds  String[]           // Array of user IDs participating
  studentId       String?            // Optional reference to student if conversation involves one
  applicationId   String?            // Optional reference to application if conversation is about one
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  lastMessageAt   DateTime           @default(now())
  messages        ConversationMessage[]
  student         Student?           @relation(fields: [studentId], references: [id])
  application     Application?       @relation(fields: [applicationId], references: [id])

  @@map("conversations")
}

model ConversationMessage {
  id              String       @id @default(cuid())
  conversationId  String
  senderId        String       // User ID of sender
  senderRole      UserRole     // Role of sender for easy identification
  text            String
  createdAt       DateTime     @default(now())
  readBy          String[]     // Array of user IDs who have read this message
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@map("conversation_messages")
}

model Donor {
  id                 String        @id @default(cuid())
  name               String
  email              String        @unique
  organization       String?
  phone              String?
  totalFunded        Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  country            String?
  address            String?
  currencyPreference Currency?
  taxId              String?
  sponsorships       Sponsorship[]
  User               User?

  @@map("donors")
}

model Sponsorship {
  id                    String    @id @default(cuid())
  donorId               String
  studentId             String
  amount                Int
  date                  DateTime  @default(now())
  status                String    @default("active")
  paymentFrequency      String?
  stripePaymentIntentId String?
  stripeSubscriptionId  String?
  amountOriginal        Int?
  currencyOriginal      Currency?
  amountBaseUSD         Int?
  baseCurrency          Currency? @default(USD)
  fxRateToUSD           Float?
  fxAsOf                DateTime?
  donor                 Donor     @relation(fields: [donorId], references: [id], onDelete: Cascade)
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("sponsorships")
}

model Disbursement {
  id               String             @id @default(cuid())
  studentId        String
  amount           Int
  date             DateTime           @default(now())
  status           DisbursementStatus @default(INITIATED)
  notes            String?
  amountOriginal   Int?
  currencyOriginal Currency?
  amountBaseUSD    Int?
  baseCurrency     Currency?          @default(USD)
  fxRateToUSD      Float?
  fxAsOf           DateTime?
  student          Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("disbursements")
}

model Document {
  id            String       @id @default(cuid())
  studentId     String
  applicationId String?
  type          DocumentType
  url           String
  originalName  String?
  mimeType      String?
  size          Int?
  uploadedAt    DateTime     @default(now())
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  student       Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([applicationId])
  @@map("documents")
}

model User {
  id             String          @id @default(cuid())
  name           String?
  email          String          @unique
  passwordHash   String
  role           UserRole
  studentId      String?         @unique
  donorId        String?         @unique
  createdAt      DateTime        @default(now())
  updatedAt            DateTime              @updatedAt
  fieldReviews         FieldReview[]         @relation("OfficerReviews")
  passwordResets       PasswordReset[]
  sentMessages         ConversationMessage[] // Messages sent by this user
  donor                Donor?                @relation(fields: [donorId], references: [id])
  student              Student?              @relation(fields: [studentId], references: [id])

  @@map("users")
}

model FxRate {
  id     String   @id @default(cuid())
  base   Currency
  quote  Currency
  rate   Float
  asOf   DateTime @default(now())
  source String?

  @@unique([base, quote, asOf])
  @@map("fx_rates")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_resets")
}

model FieldReview {
  id                           String      @id @default(cuid())
  applicationId                String
  studentId                    String
  officerUserId                String
  status                       String      @default("PENDING")
  notes                        String?
  recommendation               String?
  homeVisitDate                DateTime?
  homeVisitNotes               String?
  familyInterviewNotes         String?
  financialVerificationNotes   String?
  characterAssessment          String?
  deservingnessFactor          Int?
  documentsVerified            Boolean     @default(false)
  identityVerified             Boolean     @default(false)
  familyIncomeVerified         Boolean     @default(false)
  educationVerified            Boolean     @default(false)
  recommendationReason         String?
  additionalDocumentsRequested String[]
  riskFactors                  String[]
  verificationScore            Int?
  fielderRecommendation        String?
  adminNotesRequired           String?
  createdAt                    DateTime    @default(now())
  updatedAt                    DateTime    @updatedAt
  application                  Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  officer                      User        @relation("OfficerReviews", fields: [officerUserId], references: [id], onDelete: Cascade)
  student                      Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([studentId])
  @@index([officerUserId])
  @@map("field_reviews")
}

enum ApplicationStatus {
  PENDING
  PROCESSING
  APPROVED
  REJECTED
  DRAFT
}

enum DisbursementStatus {
  INITIATED
  COMPLETED
  FAILED
}

enum UserRole {
  STUDENT
  DONOR
  ADMIN
  FIELD_OFFICER
}

enum DocumentType {
  CNIC
  GUARDIAN_CNIC
  PHOTO
  SSC_RESULT
  HSSC_RESULT
  UNIVERSITY_CARD
  FEE_INVOICE
  INCOME_CERTIFICATE
  UTILITY_BILL
  TRANSCRIPT
  DEGREE_CERTIFICATE
  ENROLLMENT_CERTIFICATE
  OTHER
}

enum Currency {
  USD
  PKR
}

enum ConversationType {
  DONOR_STUDENT      // Direct donor-student communication
  DONOR_ADMIN        // Donor asking questions to admin/sub-admin
  STUDENT_ADMIN      // Existing student-admin communication (compatibility)
}
