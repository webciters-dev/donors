generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Connection pool configuration for production performance
  // Default pool size is 10, but can be increased based on workload
  // Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE?connection_limit=20&pool_timeout=10
}

model Student {
  id                    String            @id @default(cuid())
  name                  String
  email                 String            @unique
  gender                String
  university            String            // Keep as string for backward compatibility
  universityId          String?           // New: reference to University model
  field                 String
  program               String
  degreeLevel           String?           // Degree level: Associate, Bachelor's, Master's, etc.
  gpa                   Float
  gradYear              Int
  city                  String?
  country               String
  province              String?
  sponsored             Boolean           @default(false)
  studentPhase          StudentPhase?     @default(APPLICATION)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  cnic                  String?
  dateOfBirth           DateTime?
  guardianName          String?
  guardianCnic          String?
  guardian2Name         String?
  guardian2Cnic         String?
  phone                 String?
  guardianPhone1        String?
  guardianPhone2        String?
  address               String?
  currentInstitution    String?
  currentCity           String?
  currentCompletionYear Int?
  personalIntroduction  String?
  academicAchievements  String?
  careerGoals           String?
  communityInvolvement  String?
  currentAcademicYear   String?
  familySize            Int?
  monthlyFamilyIncome   String?
  parentsOccupation     String?
  specificField         String?
  // Student Photo fields
  photoUrl              String?           // URL to full-size photo
  photoThumbnailUrl     String?           // URL to thumbnail version
  photoUploadedAt       DateTime?         // When photo was uploaded
  photoOriginalName     String?           // Original filename for reference
  // Social Media fields
  facebookUrl           String?           // Facebook profile URL
  instagramHandle       String?           // Instagram handle with @
  whatsappNumber        String?           // WhatsApp number with country code
  linkedinUrl           String?           // LinkedIn profile URL
  twitterHandle         String?           // Twitter/X handle with @
  tiktokHandle          String?           // TikTok handle with @
  // Introduction Video fields
  introVideoUrl         String?           // URL to introduction video (MP4)
  introVideoThumbnailUrl String?          // URL to video thumbnail image
  introVideoUploadedAt  DateTime?         // When video was uploaded
  introVideoDuration    Int?              // Video duration in seconds (30-120 acceptable)
  introVideoOriginalName String?          // Original filename for reference
  messages              Message[]
  applications          Application[]
  conversations         Conversation[]
  disbursements         Disbursement[]
  documents             Document[]
  fieldReviews          FieldReview[]
  sponsorships          Sponsorship[]
  progressUpdates       StudentProgress[]
  progressReports       ProgressReport[]
  interviews            Interview[]
  User                  User?
  universityRef         University?       @relation("StudentUniversity", fields: [universityId], references: [id])

  @@map("students")
}

model Application {
  id                 String            @id @default(cuid())
  studentId          String
  term               String
  amount             Int               // Required: Education cost in specified currency
  currency           Currency          // Required: Currency of the education cost
  status             ApplicationStatus @default(PENDING)
  submittedAt        DateTime          @default(now())
  notes              String?
  fxRate             Float?
  amountOriginal     Int?
  currencyOriginal   Currency?
  amountBaseUSD      Int?
  baseCurrency       Currency?         @default(USD)
  fxRateToUSD        Float?
  fxAsOf             DateTime?
  tuitionFee         Int?
  hostelFee          Int?
  otherExpenses      Int?
  familyIncome       Int?
  familyContribution Int?
  purpose            String?
  approvalReason     String?
  livingExpenses     Int?
  scholarshipAmount  Int?
  totalExpense       Int?
  universityFee      Int?
  university         String?           // University name (for backward compatibility)
  universityId       String?           // New: reference to University model
  messages           Message[]
  student            Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  universityRef      University?       @relation("ApplicationUniversity", fields: [universityId], references: [id])
  conversations      Conversation[]
  documents          Document[]
  fieldReviews       FieldReview[]
  interviews         Interview[]

  @@map("applications")
}

model Message {
  id            String       @id @default(cuid())
  text          String
  fromRole      String
  createdAt     DateTime     @default(now())
  studentId     String
  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id])
  student       Student      @relation(fields: [studentId], references: [id])
}

model Conversation {
  id             String                @id @default(cuid())
  type           ConversationType
  participantIds String[]
  studentId      String?
  applicationId  String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  lastMessageAt  DateTime              @default(now())
  messages       ConversationMessage[]
  application    Application?          @relation(fields: [applicationId], references: [id])
  student        Student?              @relation(fields: [studentId], references: [id])

  @@map("conversations")
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  senderRole     UserRole
  text           String
  createdAt      DateTime     @default(now())
  readBy         String[]
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@map("conversation_messages")
}

model Donor {
  id                 String        @id @default(cuid())
  name               String
  email              String        @unique
  organization       String?
  totalFunded        Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  country            String?
  address            String?
  currencyPreference Currency?
  taxId              String?
  phone              String?
  sponsorships       Sponsorship[]
  User               User?

  @@map("donors")
}

model Sponsorship {
  id                    String    @id @default(cuid())
  donorId               String
  studentId             String
  amount                Int
  date                  DateTime  @default(now())
  status                String    @default("active")
  paymentFrequency      String?
  stripePaymentIntentId String?
  stripeSubscriptionId  String?
  amountOriginal        Int?
  currencyOriginal      Currency?
  amountBaseUSD         Int?
  baseCurrency          Currency? @default(USD)
  fxRateToUSD           Float?
  fxAsOf                DateTime?
  donor                 Donor     @relation(fields: [donorId], references: [id], onDelete: Cascade)
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("sponsorships")
}

model Disbursement {
  id               String             @id @default(cuid())
  studentId        String
  amount           Int
  date             DateTime           @default(now())
  status           DisbursementStatus @default(INITIATED)
  notes            String?
  amountOriginal   Int?
  currencyOriginal Currency?
  amountBaseUSD    Int?
  baseCurrency     Currency?          @default(USD)
  fxRateToUSD      Float?
  fxAsOf           DateTime?
  student          Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("disbursements")
}

model Document {
  id            String       @id @default(cuid())
  studentId     String
  applicationId String?
  type          DocumentType
  url           String
  originalName  String?
  mimeType      String?
  size          Int?
  uploadedAt    DateTime     @default(now())
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  student       Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([applicationId])
  @@map("documents")
}

model User {
  id             String                @id @default(cuid())
  name           String?
  email          String                @unique
  passwordHash   String
  role           UserRole
  studentId      String?               @unique
  donorId        String?               @unique
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  sentMessages   ConversationMessage[]
  fieldReviews   FieldReview[]         @relation("OfficerReviews")
  passwordResets PasswordReset[]
  donor          Donor?                @relation(fields: [donorId], references: [id])
  student        Student?              @relation(fields: [studentId], references: [id])

  @@map("users")
}

model FxRate {
  id     String   @id @default(cuid())
  base   Currency
  quote  Currency
  rate   Float
  asOf   DateTime @default(now())
  source String?

  @@unique([base, quote, asOf])
  @@map("fx_rates")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_resets")
}

model FieldReview {
  id                           String                 @id @default(cuid())
  applicationId                String
  studentId                    String
  officerUserId                String
  taskType                     CaseWorkerTaskType?    // New: Specific task assignment
  status                       String                 @default("PENDING")
  notes                        String?
  recommendation               String?
  homeVisitDate                DateTime?
  homeVisitNotes               String?
  familyInterviewNotes         String?
  financialVerificationNotes   String?
  characterAssessment          String?
  deservingnessFactor          Int?
  documentsVerified            Boolean                @default(false)
  identityVerified             Boolean                @default(false)
  familyIncomeVerified         Boolean                @default(false)
  educationVerified            Boolean                @default(false)
  recommendationReason         String?
  additionalDocumentsRequested String[]
  riskFactors                  String[]
  verificationScore            Int?
  fielderRecommendation        String?
  adminNotesRequired           String?
  createdAt                    DateTime               @default(now())
  updatedAt                    DateTime               @updatedAt
  application                  Application            @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  officer                      User                   @relation("OfficerReviews", fields: [officerUserId], references: [id], onDelete: Cascade)
  student                      Student                @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([studentId])
  @@index([officerUserId])
  @@index([taskType])
  @@map("field_reviews")
}

model StudentProgress {
  id               String   @id @default(cuid())
  studentId        String
  term             String
  gpa              Float
  coursesCompleted Int?
  creditsEarned    Int?
  achievements     String?
  challenges       String?
  goals            String?
  notes            String?
  updateType       String   @default("academic")
  documents        Json?
  submittedAt      DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([submittedAt])
  @@map("student_progress")
}

enum ApplicationStatus {
  PENDING
  PROCESSING
  CASE_WORKER_APPROVED
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  BOARD_APPROVED
  APPROVED
  REJECTED
  DRAFT
}

enum StudentPhase {
  APPLICATION  // Student is in application/review phase
  ACTIVE      // Student is approved and actively studying (with/without sponsor)
  GRADUATED   // Student has completed their program
}

enum DisbursementStatus {
  INITIATED
  COMPLETED
  FAILED
}

enum UserRole {
  STUDENT
  DONOR
  ADMIN
  SUB_ADMIN         // Backward compatibility - now called Case Workers in UI
  CASE_WORKER       // New term (maps to same functionality as SUB_ADMIN)
  SUPER_ADMIN       // Super Admin - can only manage admin credentials
}

enum CaseWorkerTaskType {
  DOCUMENT_REVIEW
  FIELD_VISIT
  CNIC_VERIFICATION
}

enum DocumentType {
  CNIC
  GUARDIAN_CNIC
  PHOTO
  SSC_RESULT
  HSSC_RESULT
  UNIVERSITY_CARD
  FEE_INVOICE
  INCOME_CERTIFICATE
  UTILITY_BILL
  TRANSCRIPT
  DEGREE_CERTIFICATE
  ENROLLMENT_CERTIFICATE
  SECOND_GUARDIAN_CNIC
  OTHER
}

enum Currency {
  USD
  PKR
  EUR
  GBP
  CAD
  AUD
}

enum ConversationType {
  DONOR_STUDENT
  DONOR_ADMIN
  STUDENT_ADMIN
}

enum ProgressReportStatus {
  SUBMITTED
  REVIEWED
  APPROVED
  NEEDS_REVISION
}

model ProgressReport {
  id          String                      @id @default(cuid())
  studentId   String
  title       String
  content     String
  status      ProgressReportStatus        @default(SUBMITTED)
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?
  
  student     Student                     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  attachments ProgressReportAttachment[]
  
  @@map("progress_reports")
}

model ProgressReportAttachment {
  id               String         @id @default(cuid())
  progressReportId String
  filename         String
  filepath         String
  mimetype         String
  size             Int
  createdAt        DateTime       @default(now())
  
  progressReport   ProgressReport @relation(fields: [progressReportId], references: [id], onDelete: Cascade)
  
  @@map("progress_report_attachments")
}

model University {
  id            String                   @id @default(cuid())
  name          String
  country       String
  isOfficial    Boolean                  @default(false) // Whether it appears in dropdown
  isCustom      Boolean                  @default(false) // Was originally submitted as "Other"
  submittedBy   String?                  // Student ID who first submitted this custom university
  approvedBy    String?                  // Admin ID who approved this university
  approvedAt    DateTime?                // When it was approved
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  
  // Track which applications used this university
  students      Student[]                @relation("StudentUniversity")
  applications  Application[]            @relation("ApplicationUniversity")
  
  // Academic offerings
  degreeLevels UniversityDegreeLevel[]
  fields       UniversityField[]
  programs     UniversityProgram[]
  
  @@unique([name, country]) // Prevent duplicate universities per country
  @@map("universities")
}

model UniversityDegreeLevel {
  id           String                @id @default(cuid())
  universityId String
  degreeLevel  String                // "Associate", "Bachelor's", "Master's", etc.
  createdAt    DateTime              @default(now())
  
  university   University            @relation(fields: [universityId], references: [id], onDelete: Cascade)
  fields       UniversityField[]
  programs     UniversityProgram[]
  
  @@unique([universityId, degreeLevel]) // Prevent duplicate degree levels per university
  @@map("university_degree_levels")
}

model UniversityField {
  id                     String               @id @default(cuid())
  universityId           String
  universityDegreeLevelId String
  degreeLevel            String               // Denormal for easier querying
  fieldName              String               // "Computer Science", "Engineering", etc.
  createdAt              DateTime             @default(now())
  
  university             University           @relation(fields: [universityId], references: [id], onDelete: Cascade)
  degreeLevelRef         UniversityDegreeLevel @relation(fields: [universityDegreeLevelId], references: [id], onDelete: Cascade)
  programs               UniversityProgram[]
  
  @@unique([universityId, degreeLevel, fieldName]) // Prevent duplicate fields per university/degree
  @@map("university_fields")
}

model UniversityProgram {
  id                     String               @id @default(cuid())
  universityId           String
  universityDegreeLevelId String
  universityFieldId      String
  degreeLevel            String               // Denormalized for easier querying
  fieldName              String               // Denormalized for easier querying
  programName            String               // "Computer Science", "Software Engineering", etc.
  createdAt              DateTime             @default(now())
  
  university             University           @relation(fields: [universityId], references: [id], onDelete: Cascade)
  degreeLevelRef         UniversityDegreeLevel @relation(fields: [universityDegreeLevelId], references: [id], onDelete: Cascade)
  fieldRef               UniversityField      @relation(fields: [universityFieldId], references: [id], onDelete: Cascade)
  
  @@unique([universityId, degreeLevel, fieldName, programName]) // Prevent duplicate programs
  @@map("university_programs")
}

// Board Member Interview System Models
model BoardMember {
  id               String                @id @default(cuid())
  name             String
  email            String                @unique
  title            String?               // "Chairman", "Member", "Secretary"
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  
  // Relationships
  interviews       InterviewPanelMember[]
  decisions        InterviewDecision[]
  
  @@map("board_members")
}

model Interview {
  id               String                @id @default(cuid())
  studentId        String
  applicationId    String
  
  // Schedule Details
  scheduledAt      DateTime
  meetingLink      String?               // Google Meet/Zoom/Teams link
  notes            String?
  status           InterviewStatus       @default(SCHEDULED)
  
  // Administrative
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  
  // Relationships
  student          Student               @relation(fields: [studentId], references: [id])
  application      Application           @relation(fields: [applicationId], references: [id])
  panelMembers     InterviewPanelMember[]
  decisions        InterviewDecision[]
  
  @@map("interviews")
}

model InterviewPanelMember {
  id               String                @id @default(cuid())
  interviewId      String
  boardMemberId    String
  isChairperson    Boolean               @default(false)
  createdAt        DateTime              @default(now())
  
  interview        Interview             @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  boardMember      BoardMember           @relation(fields: [boardMemberId], references: [id])
  
  @@unique([interviewId, boardMemberId])
  @@map("interview_panel_members")
}

model InterviewDecision {
  id               String                @id @default(cuid())
  interviewId      String
  boardMemberId    String
  decision         DecisionType          @default(PENDING)
  comments         String?
  submittedAt      DateTime              @default(now())
  
  interview        Interview             @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  boardMember      BoardMember           @relation(fields: [boardMemberId], references: [id])
  
  @@unique([interviewId, boardMemberId])
  @@map("interview_decisions")
}

// Board Interview System Enums
enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS  
  COMPLETED
  CANCELLED
}

enum DecisionType {
  APPROVE
  REJECT
  ABSTAIN
  PENDING
}

// Audit Log Model for Security Tracking
model AuditLog {
  id            String   @id @default(cuid())
  userId        String   // User who performed the action
  userEmail     String   // Email for easier tracking
  userRole      String   // Role at time of action (ADMIN, SUPER_ADMIN, etc.)
  action        String   // Action performed (CREATE, UPDATE, DELETE, LOGIN, etc.)
  resourceType  String   // Type of resource (Student, Donor, Application, User, etc.)
  resourceId    String?  // ID of the affected resource
  ipAddress     String?  // IP address of the user
  userAgent     String?  // Browser/client information
  changes       Json?    // JSON object with before/after values for updates
  metadata      Json?    // Additional context (request params, query, etc.)
  status        String   @default("SUCCESS") // SUCCESS, FAILED, ERROR
  errorMessage  String?  // Error details if status is FAILED/ERROR
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([userEmail])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}

// IP Whitelist Model for Admin Panel Security
model IpWhitelist {
  id          String   @id @default(cuid())
  ipAddress   String   @unique // IP address (supports CIDR notation)
  description String?  // Description/purpose of this IP
  addedBy     String   // User ID who added this IP
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ipAddress])
  @@index([isActive])
  @@map("ip_whitelist")
}
