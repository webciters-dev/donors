# Global .copilot-instructions.md - Quality Standards

**Location**: `c:\projects\.copilot-instructions.md`
**Applies To**: All projects in c:\projects\
**Version**: 1.0.0 | Last Updated: 2025-01-15

This file establishes universal quality standards and best practices for Copilot-assisted development. Use this to maintain consistency across all projects and prevent repeating mistakes.

---

## üéØ Core Principles

1. **Verify, Don't Assume** - Always check that what you think is true is actually true
2. **Trace, Don't Guess** - Follow code execution paths step-by-step to diagnose issues
3. **Document, Don't Memorize** - Record findings for future reference
4. **Test, Don't Hope** - Verify changes work before declaring success
5. **Communicate, Don't Isolate** - Explain what you're doing and why

---

## üìã The 16 Essential Quality Checks

### 1. CODE VERIFICATION
- [ ] **Commit integrity**: Verify all files in a commit match what was intended
- [ ] **File content match**: Confirm local file = GitHub file = VPS file
- [ ] **Line-by-line comparison**: When suspecting divergence, do full diff

**How to verify:**
```bash
git show <commit>                              # See what changed
git show origin/main:path/to/file > temp.js   # Get GitHub version
diff localfile temp.js                        # Compare line-by-line
ssh user@host cat path/to/file | diff - local # Compare with VPS
```

### 2. API INTEGRITY
- [ ] **Endpoint accessibility**: Verify all API routes are actually accessible
- [ ] **Authentication flows**: Confirm auth tokens work and expire correctly
- [ ] **Request/response schemas**: Data returned matches what frontend expects

**Test with:**
```bash
curl -X GET https://domain/api/endpoint
curl -v https://domain/api/endpoint                    # With headers
curl -X POST -H "Content-Type: application/json" \
  -d '{"key":"value"}' https://domain/api/endpoint
```

### 3. DATA FLOW VERIFICATION
- [ ] **Frontend ‚Üí Backend**: Data sent from UI actually reaches backend
- [ ] **Backend ‚Üí Database**: Data saved actually persists in DB
- [ ] **Database ‚Üí Frontend**: Data retrieved displays correctly in UI

**Trace by adding:**
```javascript
console.log('Frontend sending:', data);          // Browser DevTools
console.log('Backend received:', req.body);      // Server console
SELECT * FROM table WHERE id = 123;              // DB query
console.log('Returning to frontend:', response); // Server console
```

### 4. FILE & UPLOAD OPERATIONS
- [ ] **Upload path**: Files uploaded go to correct location
- [ ] **File accessibility**: Uploaded files accessible via HTTP URL
- [ ] **File persistence**: Files remain after restart/redeploy

**For Donor Project:**
```bash
# Check uploads exist
ls -lh ~/projects/donors/server/uploads/photos/

# Test HTTP access
curl -I https://aircrew.nl/uploads/photos/filename.jpg

# Test persistence
pm2 restart all
# Verify file still exists after restart
```

### 5. DATABASE OPERATIONS
- [ ] **Query execution**: Queries run and return expected results
- [ ] **Transaction integrity**: Multi-step operations complete or roll back atomically
- [ ] **Data consistency**: No orphaned records, referential integrity maintained

**Query database:**
```bash
psql -d donors_db -c "SELECT * FROM students LIMIT 1"
psql -d donors_db -c "SELECT COUNT(*) FROM applications WHERE student_id = 123"
```

### 6. AUTHENTICATION & AUTHORIZATION
- [ ] **Session management**: Users login/logout, sessions manage correctly
- [ ] **Role-based access**: Users only see/do what their role allows
- [ ] **Token security**: JWT tokens valid, refreshed correctly, revoked properly

**Test flows:**
```
1. Login as CASE_WORKER ‚Üí get token
2. Try accessing /api/admin ‚Üí should return 403
3. Access /api/cases ‚Üí should return 200
4. Logout ‚Üí token should be invalid
5. Try using old token ‚Üí should return 401
```

### 7. IMPORT & MODULE RESOLUTION
- [ ] **Import paths**: All imports resolve correctly
- [ ] **Circular dependencies**: No circular imports causing issues
- [ ] **Dynamic imports**: Late-loaded modules actually exist at runtime

**Check for issues:**
```bash
grep -r "require\|import" src/ | grep -E "\\.\\..*\\.\\..*\\.\\..*\\.\\."  # Too many ../
node -e "require('./path/to/module')"  # Manual require test
```

### 8. ENVIRONMENT & CONFIGURATION
- [ ] **Environment variables**: All required ENV vars set correctly
- [ ] **Configuration loading**: App reads config from correct source
- [ ] **Secrets management**: No secrets in code/logs

**Check ENV vars:**
```bash
# Local
cat .env | grep -v "#"

# VPS
ssh user@host "echo $DATABASE_URL"
ssh user@host "cat ~/.bashrc | grep DATABASE"

# Should NOT find:
grep -r "password\|secret\|api_key" src/ | grep -v ".env\|//"
```

### 9. BUILD & COMPILATION
- [ ] **Build succeeds**: `npm run build` completes without errors
- [ ] **Output correct**: Built files match source files
- [ ] **No build artifacts left**: Old files removed, cache cleared

**Build verification:**
```bash
rm -rf dist/ node_modules/     # Clean everything
npm ci                         # Fresh install
npm run build                  # Build
ls -la dist/                   # Verify output
```

### 10. GIT WORKFLOW
- [ ] **Commit messages clear**: What was changed and why
- [ ] **No uncommitted changes**: `git status` shows clean state
- [ ] **Tracking correct branch**: Local tracking matches remote

**Before every deploy:**
```bash
git status                     # Should show "working tree clean"
git log --oneline -1           # See last commit
git branch -vv                 # See which branch, what remote
```

### 11. TEST COVERAGE
- [ ] **Unit tests pass**: `npm test` exits 0, all assertions pass
- [ ] **Integration tests pass**: Full workflows work
- [ ] **Manual testing done**: Fresh browser session, clear cache

**Test the feature:**
```
Manual:
1. Open incognito window
2. Perform the action (upload, delete, navigate)
3. Check data persists (refresh page, logout/login)
4. Check on different browser/device
```

### 12. CODE QUALITY
- [ ] **Linting passes**: `npm run lint` shows 0 errors
- [ ] **No console.error in code**: Removed debug logging
- [ ] **Error handling comprehensive**: All error paths handled

**Before commit:**
```bash
npm run lint                   # 0 errors required
grep -r "console\." src/ | grep -v "//" | wc -l  # Should be ~0
grep -r "TODO\|FIXME\|HACK" src/ | wc -l  # Review if > 0
```

### 13. ERROR HANDLING EXCELLENCE
- [ ] **Standard error codes used**: Use ErrorCodes.CATEGORY.ERROR_NAME
- [ ] **Context included**: Error logs include requestId, userId, route
- [ ] **User-friendly messages**: Frontend user sees helpful text, not stack traces

**Proper error handling:**
```javascript
// ‚ùå Bad
throw new Error('Something went wrong');

// ‚úÖ Good
throw new AppError(ErrorCodes.FILE.UPLOAD_FAILED, 'Failed to upload photo', {
  studentId: 123,
  filename: 'photo.jpg'
});
```

### 14. BACKWARDS COMPATIBILITY
- [ ] **API contract maintained**: Existing endpoints work for old clients
- [ ] **Database schema migrations**: Old data still accessible
- [ ] **UI layouts responsive**: Works on older browsers

**Before removing/changing:**
```
1. Search codebase for old field name
2. Check client apps still need it
3. Plan deprecation period
4. Provide migration instructions
```

### 15. SECURITY BEST PRACTICES
- [ ] **Input validation**: User input validated before use
- [ ] **Authorization checks**: Every endpoint verifies user permission
- [ ] **Secrets protected**: No API keys in logs, errors, or client

**Security checklist:**
```
1. Does endpoint check user role? (/api/admin should have auth middleware)
2. Can I access someone else's data? (Try changing ID in URL)
3. Are secrets in .gitignore? (grep -r "password" .git/ should be 0)
4. Are errors exposing DB schema? (No "FOREIGN KEY" in error responses)
```

### 16. DOCUMENTATION
- [ ] **Changes documented**: README/docs updated to reflect changes
- [ ] **Code comments**: Complex logic explained
- [ ] **Error codes cataloged**: New error codes added to ErrorCodes.js

**After making changes:**
```bash
1. Update README.md if feature is user-facing
2. Add JSDoc comments to complex functions
3. Update ErrorCodes.js if using new error codes
4. Add to CHANGELOG if major change
```

---

## üö® Common Mistakes & Root Causes

### ‚ùå Mistake 1: Assuming code deployed without verification
**What happens**: Say "code is on VPS" but it's actually stale
**Root cause**: Not comparing local vs GitHub vs VPS
**Fix**: Use `git show origin/main:<file>` then `ssh host cat <file>`

### ‚ùå Mistake 2: Rebuilding without cleaning cache
**What happens**: `npm run build` uses old dist/, changes don't show
**Root cause**: Build tool caches intermediate files
**Fix**: `rm -rf dist/ node_modules/; npm ci; npm run build`

### ‚ùå Mistake 3: Ignoring file timestamps
**What happens**: Photo exists but timestamp shows it's old
**Root cause**: File wasn't actually updated, just checked for HTTP access
**Fix**: `stat ~/uploads/photo.jpg` to see modification time

### ‚ùå Mistake 4: Generic error messages
**What happens**: Users see "Error occurred" without knowing what happened
**Root cause**: Not using structured error codes
**Fix**: Use ErrorCodes.CATEGORY.ERROR_NAME with custom message for user

### ‚ùå Mistake 5: Not checking database persistence
**What happens**: Data shows in frontend but doesn't persist after page refresh
**Root cause**: Data in memory/cache, not actually in database
**Fix**: Query database directly: `SELECT * FROM table WHERE id = 123`

### ‚ùå Mistake 6: Forgetting auth middleware on protected routes
**What happens**: Route works for logged-in user but doesn't check in code
**Root cause**: Lazy to add auth check, assumes frontend handles it
**Fix**: Add auth middleware to EVERY protected endpoint

### ‚ùå Mistake 7: Too much logging or too little
**What happens**: Can't debug because either no info or flooded with noise
**Root cause**: No severity levels or strategic logging
**Fix**: Use logger with levels: error (exceptions), warn (slow queries), info (state changes)

### ‚ùå Mistake 8: Mixing business logic with HTTP handling
**What happens**: Can't test logic without making full HTTP request
**Root cause**: Logic tightly coupled to Express
**Fix**: Separate core functions from route handlers

---

## üîç Debugging Checklist (When Things Break)

Use this when something doesn't work as expected:

**Step 1: Ask Questions**
- When did it last work?
- What changed since then?
- What's the exact error message?
- Is it broken locally, on VPS, or both?

**Step 2: Verify Before Fixing**
- Check actual error (DevTools Network tab, server logs)
- Not assumption of what error is
- Reproduce consistently (not random)
- Narrow down to specific step

**Step 3: Trace Data Flow**
```
Frontend:  What data is being sent?     (DevTools Network)
Backend:   What data is being received? (console.log in route)
Database:  What data is stored?         (SQL query)
Response:  What data is being returned? (DevTools Response)
```

**Step 4: Check All Layers**
- Application code (GitHub)
- Frontend build (dist/ folder timestamps)
- Web server config (Nginx)
- Backend running (PM2 status)
- Database connection (psql test)

**Step 5: Verify The Fix**
- Fix reproduces problem
- Fix solves it without breaking something else
- Fix tested in multiple scenarios
- Fix documented with WHY comment

---

## ‚úÖ Pre-Deployment Checklist

**DO NOT DEPLOY without checking these:**

### Local Testing
- [ ] Feature works on localhost
- [ ] No console errors in DevTools
- [ ] Database queries are correct
- [ ] Logs show expected messages

### Code Quality
- [ ] `npm run lint` passes (0 errors)
- [ ] `npm test` passes (if tests exist)
- [ ] No console.log or debug code left
- [ ] Comments explain complex logic

### Git
- [ ] `git status` shows clean working tree
- [ ] Commit message is descriptive
- [ ] Commit includes only intended changes
- [ ] `git log --oneline` shows correct history

### GitHub
- [ ] Code pushed to main branch
- [ ] `git show origin/main` shows your changes
- [ ] GitHub Actions pass (if configured)

### VPS Deployment
- [ ] SSH to VPS and verify login
- [ ] `cd /path/to/project`
- [ ] `git pull origin main` succeeds
- [ ] Compare: `git show HEAD:<file>` vs `cat <file>`
- [ ] `npm run build` succeeds (0 errors)
- [ ] `pm2 restart all` succeeds
- [ ] Test feature on https://domain
- [ ] Check `/logs/` for errors
- [ ] Verify PM2 processes are online

---

## üéì For the Donor Project Specifically

### Photo Upload Feature
```
Verify:
1. File uploaded to: /home/sohail/projects/donors/server/uploads/photos/
2. Nginx configured: /etc/nginx/sites-enabled/aircrew.nl has /uploads/ location
3. Test URL: curl -I https://aircrew.nl/uploads/photos/filename.jpg
4. Result: HTTP/2 200, not 404
5. Persists after: pm2 restart all
```

### Case Worker Dashboard
```
Verify:
1. Case workers can only see their own students
2. Route protected: GET /api/case-worker/students
3. Auth check: verifies role = CASE_WORKER
4. Data correct: student name, email, CNIC, program, university
5. Navigation: "View Details" button works
```

### Video Upload Validation
```
Verify:
1. Accepts: 30-120 seconds
2. Rejects: < 30 seconds with helpful message
3. Rejects: > 120 seconds with helpful message
4. File: server/routes/uploadRoutes.js has validation logic
5. Frontend: src/components/VideoUploader.jsx shows duration feedback
```

---

## üìû Getting Help

**Good questions include:**
- ‚úÖ "I changed X, but Y still doesn't work. Error: [paste error]"
- ‚úÖ "I verified Z exists, but API returns 404. curl output: [paste result]"
- ‚úÖ "Code on GitHub looks correct, but VPS different. git show vs cat: [paste diff]"

**Poor questions that waste time:**
- ‚ùå "Something broke"
- ‚ùå "Code doesn't work"
- ‚ùå "Why is photo not showing?" (without error logs)

**Always include:**
1. What you tried to do
2. What actually happened
3. The error message or unexpected result
4. Steps to reproduce
5. What you already checked

---

## üìö Related Files

- **Error Codes**: `c:\projects\donor\server\utils\errorCodes.js`
- **Error Handler**: `c:\projects\donor\server\utils\appError.js`
- **Logger**: `c:\projects\donor\server\utils\logger.js`
- **Integration Guide**: Check ERROR_HANDLING_SYSTEM folder

---

**Remember**: This file is your quality checklist. Before EVERY commit and deploy, go through the relevant sections. It's the difference between "I hope this works" and "I know this works."

